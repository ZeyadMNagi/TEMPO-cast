<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="tempo_viewer_title">TEMPO Multi-Layer Viewer</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>
    <link rel="stylesheet" href="../css/style.css" />
    <link id="rtl-stylesheet" rel="stylesheet" href="../css/rtl.css" disabled />
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      #map {
        flex-grow: 1;
        width: 100%;
        height: 95%;
      }
      footer {
        flex-grow: 0;
      }
      .gems-loading {
        padding: 10px;
        background: rgba(255, 200, 0, 0.9);
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
      }
      .gems-error {
        padding: 10px;
        background: rgba(244, 67, 54, 0.9);
        color: white;
        border-radius: 5px;
        font-size: 12px;
      }
      .gems-success {
        padding: 10px;
        background: rgba(76, 175, 80, 0.9);
        color: white;
        border-radius: 5px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <a href="../index.html" class="logo">Global TEMPO</a>
        <button class="nav-toggle" id="navToggle" aria-label="Open menu">
          <span class="hamburger"></span>
        </button>
        <ul class="nav-links" id="navLinks">
          <li>
            <a href="../index.html#about" class="nav-item" data-i18n="nav_about"
              >About</a
            >
          </li>
          <li>
            <a
              href="../index.html#resources"
              class="nav-item"
              data-i18n="nav_resources"
              >Resources</a
            >
          </li>
          <li>
            <a href="../WHO.html" class="nav-item" data-i18n="nav_who"
              >WHO Instructions</a
            >
          </li>
          <li>
            <a href="./index.html" class="nav-item" data-i18n="nav_app">App</a>
          </li>
          <li>
            <a
              href="./TEMPOData.html"
              class="nav-item active"
              data-i18n="nav_tempo_data"
              >TEMPO Data</a
            >
          </li>
          <li>
            <button
              id="lang-toggle-btn"
              class="nav-btn"
              style="cursor: pointer"
            >
              English
            </button>
          </li>
        </ul>
      </nav>
    </header>

    <div id="map"></div>
    <footer>
      <p>
        Developed by
        <a href="https://zeyad.dev" target="_blank">Zeyad M. Khattab</a>
      </p>
    </footer>
    <script src="../js/i18n.js"></script>
    <script>
      const map = L.map("map").setView([39.8283, -98.5795], 3.5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // ---- TEMPO Layers ----
      const no2Layer = L.esri.imageMapLayer({
        url: "https://gis.earthdata.nasa.gov/image/rest/services/C3685896708-LARC_CLOUD/TEMPO_NO2_L3_V04_HOURLY_TROPOSPHERIC_VERTICAL_COLUMN/ImageServer",
        attribution: "NASA TEMPO NO₂",
      });

      const o3Layer = L.esri.imageMapLayer({
        url: "https://gis.earthdata.nasa.gov/image/rest/services/C3685896625-LARC_CLOUD/TEMPO_O3TOT_L3_V04_HOURLY_OZONE_COLUMN_AMOUNT/ImageServer",
        attribution: "NASA TEMPO O₃",
      });

      const hchoLayer = L.esri.imageMapLayer({
        url: "https://gis.earthdata.nasa.gov/image/rest/services/C3685897141-LARC_CLOUD/TEMPO_HCHO_L3_V04_HOURLY_VERTICAL_COLUMN/ImageServer",
        attribution: "NASA TEMPO HCHO",
      });

      // GEMS layers - using fixed bounds, loaded on demand
      const GEMS_BOUNDS = [
        [-34, 48],
        [58, 168],
      ];

      const gemsLayers = {
        o3: L.imageOverlay("", GEMS_BOUNDS, {
          opacity: 0.5,
          attribution: "GEMS O₃ (Forecast)",
        }),
        hcho: L.imageOverlay("", GEMS_BOUNDS, {
          opacity: 0.5,
          attribution: "GEMS HCHO (Forecast)",
        }),
        no2: L.imageOverlay("", GEMS_BOUNDS, {
          opacity: 0.5,
          attribution: "GEMS NO₂ (Forecast)",
        }),
      };

      // Track which layers have been loaded
      const gemsLoadStatus = {
        o3: { loaded: false, loading: false },
        hcho: { loaded: false, loading: false },
        no2: { loaded: false, loading: false },
      };

      no2Layer.addTo(map);

      let layerControl;

      function updateLayerControl() {
        if (layerControl) {
          map.removeControl(layerControl);
        }
        const overlayMaps = {
          [getTranslation("tempo_layer_no2")]: no2Layer,
          [getTranslation("tempo_layer_o3")]: o3Layer,
          [getTranslation("tempo_layer_hcho")]: hchoLayer,
          "GEMS O₃ (Forecast)": gemsLayers.o3,
          "GEMS HCHO (Forecast)": gemsLayers.hcho,
          "GEMS NO₂ (Forecast)": gemsLayers.no2,
        };
        layerControl = L.control
          .layers(null, overlayMaps, { collapsed: false })
          .addTo(map);
      }

      const info = L.control({ position: "bottomleft" });
      info.onAdd = function () {
        this._div = L.DomUtil.create("div", "info-box leaflet-control-layers");
        this.update();
        return this._div;
      };
      info.update = function (message) {
        const defaultMsg =
          getTranslation("tempo_select_layer") || "Select layers to display";
        this._div.innerHTML = message || defaultMsg;
      };
      info.addTo(map);

      // --- GEMS Opacity Slider Control ---
      const opacityControl = L.control({ position: "bottomright" });
      opacityControl.onAdd = function (map) {
        const div = L.DomUtil.create("div", "info-box leaflet-control-layers");
        div.id = "gemsOpacityControl";
        div.style.display = "none";
        div.innerHTML =
          '<strong>GEMS Layer Opacity</strong><br><input type="range" min="0" max="1" step="0.05" value="0.5" id="gemsOpacitySlider" style="width: 120px;">';

        L.DomEvent.disableClickPropagation(div);

        div.oninput = function (e) {
          Object.values(gemsLayers).forEach((layer) => {
            if (map.hasLayer(layer)) {
              layer.setOpacity(e.target.value);
            }
          });
        };

        return div;
      };
      opacityControl.addTo(map);

      // Load GEMS layer on demand
      async function loadGemsLayer(layerName) {
        const layer = gemsLayers[layerName];
        const status = gemsLoadStatus[layerName];

        // Already loaded
        if (status.loaded) {
          console.log(`GEMS ${layerName} already loaded`);
          return;
        }

        // Already loading
        if (status.loading) {
          console.log(`GEMS ${layerName} is already loading...`);
          return;
        }

        status.loading = true;
        console.log(`Loading GEMS ${layerName.toUpperCase()}...`);
        info.update(
          `<div class="gems-loading">⏳ Loading GEMS ${layerName.toUpperCase()}... (may take 10-30s)</div>`
        );

        try {
          // Just set the image URL - bounds are already set
          const imageUrl = `/api/gems/${layerName}/image?t=${Date.now()}`;

          // Test if the endpoint responds
          const testResponse = await fetch(imageUrl, { method: "HEAD" });

          if (testResponse.ok) {
            layer.setUrl(imageUrl);
            status.loaded = true;
            status.loading = false;

            console.log(
              `✓ GEMS ${layerName.toUpperCase()} loaded successfully`
            );
            info.update(
              `<div class="gems-success">✓ GEMS ${layerName.toUpperCase()} loaded!</div>`
            );

            setTimeout(() => info.update(), 3000);
          } else {
            throw new Error(`Server returned ${testResponse.status}`);
          }
        } catch (error) {
          status.loading = false;
          console.error(`✗ Failed to load GEMS ${layerName}:`, error);

          info.update(
            `<div class="gems-error">✗ Failed to load GEMS ${layerName.toUpperCase()}<br>` +
              `The GEMS API may be slow or unavailable.<br>` +
              `<small>Error: ${error.message}</small></div>`
          );

          setTimeout(() => info.update(), 8000);

          // Remove the layer if it failed to load
          if (map.hasLayer(layer)) {
            map.removeLayer(layer);
          }
        }
      }

      // Show/hide opacity control and load data on demand
      map.on("overlayadd", (e) => {
        // Check if it's a GEMS layer
        const gemsLayerEntry = Object.entries(gemsLayers).find(
          ([key, layer]) => layer === e.layer
        );

        if (gemsLayerEntry) {
          const [layerName] = gemsLayerEntry;
          document.getElementById("gemsOpacityControl").style.display = "block";
          loadGemsLayer(layerName); // Load on demand
        }
      });

      map.on("overlayremove", (e) => {
        const anyGemsVisible = Object.values(gemsLayers).some((layer) =>
          map.hasLayer(layer)
        );
        if (!anyGemsVisible) {
          document.getElementById("gemsOpacityControl").style.display = "none";
        }
      });

      // Nav toggle script
      const navToggle = document.getElementById("navToggle");
      const navLinks = document.getElementById("navLinks");

      navToggle.addEventListener("click", function () {
        navToggle.classList.toggle("active");
        navLinks.classList.toggle("open");
      });

      document.querySelectorAll(".nav-links a").forEach((link) => {
        link.addEventListener("click", () => {
          navToggle.classList.remove("active");
          navLinks.classList.remove("open");
        });
      });

      // Override setLanguage to update map layers
      const originalSetLanguage = window.setLanguage;
      if (originalSetLanguage) {
        window.setLanguage = async function (lang) {
          await originalSetLanguage(lang);
          updateLayerControl();
          info.update();
        };
      }

      // Initial setup
      updateLayerControl();

      console.log(
        "TEMPO Data Viewer initialized. GEMS layers will load on demand when enabled."
      );
    </script>
  </body>
</html>
